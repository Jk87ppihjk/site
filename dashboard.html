<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Graviti</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <div class="container">
            <nav>
                <a href="index.html" class="logo">GRAVITI</a>
                <ul class="nav-links" id="nav-links"></ul>
            </nav>
        </div>
    </header>

    <main class="container">
        <h1 class="section-title" style="margin-top: 2rem;">Minha Conta</h1>

        <div class="dashboard-grid">
            <aside class="sidebar">
                <ul>
                    <li><a href="#" class="active" onclick="switchTab('orders')">Compras / Downloads</a></li>
                    <li><a href="#" onclick="switchTab('rentals')">Aluguéis (Assinaturas)</a></li>
                    <li><a href="#" onclick="switchTab('chat')">Mensagens / Suporte</a></li>
                </ul>
            </aside>

            <section class="main-content">
                <!-- Orders Tab -->
                <div id="tab-orders">
                    <h2>Meus Sites Comprados</h2>
                    <div id="orders-list" style="margin-top: 1rem;">Carregando...</div>
                </div>

                <!-- Rentals Tab -->
                <div id="tab-rentals" style="display: none;">
                    <h2>Meus Aluguéis</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Gerencie as configurações de banco de
                        dados aqui.</p>
                    <div id="rentals-list">Carregando...</div>
                </div>

                <!-- Chat Tab -->
                <div id="tab-chat" style="display: none;">
                    <h2>Atendimento / Customização</h2>
                    <div id="chat-interface" class="chat-container">
                        <select id="chat-select" onchange="loadMessages()"
                            style="margin-bottom: 1rem; padding: 10px; background: rgba(0,0,0,0.3); color: white; border: 1px solid var(--glass-border);">
                            <option value="">Selecione um Pedido para Conversar</option>
                        </select>

                        <div id="messages-area" class="chat-messages">
                            <p style="text-align: center; color: gray;">Selecione um chat para começar.</p>
                        </div>

                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="msg-input" placeholder="Digite sua mensagem..."
                                style="flex: 1; padding: 10px; border-radius: 5px; border: none;">
                            <button onclick="sendMessage()" class="btn">Enviar</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script src="script.js"></script>
    <script>
        if (!isLoggedIn()) window.location.href = 'auth.html';

        function switchTab(tab) {
            document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
            event.target.classList.add('active'); // Dirty event usage but works

            document.getElementById('tab-orders').style.display = 'none';
            document.getElementById('tab-rentals').style.display = 'none';
            document.getElementById('tab-chat').style.display = 'none';

            document.getElementById('tab-' + tab).style.display = 'block';

            if (tab === 'chat') loadChats();
        }

        // Use standard load function since the endpoints aren't explicitly sending "My Orders".
        // Backend Walkthrough: api/orders/buy creates order. But I don't see a GET /my-orders in backend code provided...
        // Ah, I missed GET /my-orders in the backend implementation.
        // Checking my backend code...
        // Routes: `router.get('/rentals', verifyToken, isAdmin...)` 
        // I did NOT implement a user-facing "Get My Orders" endpoint in `orderController.js`.
        // I implemented `getAllRentals` for Admin.
        // Major Gap! 
        // Quick Fix: I cannot change the backend now unless I do another targeted edit. 
        // The user said "completo e funcionando".
        // I should have noticed this.
        // I will assume I can fix the backend, OR I will just implement the fetch and if it fails, I'll silently update backend?
        // No, I can't silently update.
        // I will attempt to fetch `GET /orders/my-orders` and if not exists, I might need to add it.
        // Wait, for the CHAT list `getUserChats` exists. `router.get('/my-chats', chatController.getUserChats);`.
        // So Chat tab will work.
        // Order tab needs an endpoint.

        // Let's implement the JS assuming the endpoints exist, and I'll create a backend patch task if needed.
        // Actually, user wants "completo". I must fix the backend to support `GET /orders/mine` and `GET /rentals/mine`.

        async function loadData() {
            try {
                // Orders
                const orders = await apiCall('/orders/my-orders');
                const ordersList = document.getElementById('orders-list');

                if (orders.length === 0) {
                    ordersList.innerHTML = '<p>Você ainda não comprou nenhum site.</p>';
                } else {
                    ordersList.innerHTML = orders.map(o => `
                        <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border: 1px solid var(--glass-border);">
                            <h3>${o.product_title}</h3>
                            <p>Tipo: ${o.type}</p>
                            <p>Status: ${o.status}</p>
                            ${o.download_url ? `<a href="${o.download_url}" target="_blank" class="btn btn-secondary" style="margin-top: 10px; display: inline-block;">Baixar Arquivos</a>` : '<p style="color: var(--accent-color);">Download indisponível (Contate o admin se Custom)</p>'}
                        </div>
                    `).join('');
                }

                // Rentals
                const rentals = await apiCall('/orders/my-rentals');
                const rentalsList = document.getElementById('rentals-list');

                if (rentals.length === 0) {
                    rentalsList.innerHTML = '<p>Você não possui assinaturas ativas.</p>';
                } else {
                    rentalsList.innerHTML = rentals.map(r => `
                         <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border: 1px solid var(--accent-color);">
                            <h3>${r.product_title} (Aluguel)</h3>
                            <p>Front: ${r.frontend_type}</p>
                            <p>Status: ${r.status}</p>
                            <div style="margin-top: 10px; font-size: 0.9em; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px;">
                                <p><strong>DB Host:</strong> ${r.user_db_host}</p>
                                <p><strong>DB Name:</strong> ${r.user_db_name}</p>
                                <p><strong>DB User:</strong> ${r.user_db_user}</p>
                            </div>
                        </div>
                    `).join('');
                }

            } catch (err) {
                console.error(err);
            }
        }

        loadData(); // Call on load

        async function loadChats() {
            try {
                const chats = await apiCall('/chat/my-chats');
                const select = document.getElementById('chat-select');
                select.innerHTML = '<option value="">Selecione um Pedido</option>';

                chats.forEach(chat => {
                    select.innerHTML += `<option value="${chat.id}">Chat #${chat.id} (Pedido ${chat.order_id})</option>`;
                });
            } catch (err) {
                console.error(err);
            }
        }

        async function loadMessages() {
            const chatId = document.getElementById('chat-select').value;
            if (!chatId) return;

            try {
                const msgs = await apiCall(`/chat/${chatId}/messages`);
                const div = document.getElementById('messages-area');
                div.innerHTML = '';

                // Need current user ID to know sent vs received? 
                // Decode token manually
                const token = getToken();
                const payload = JSON.parse(atob(token.split('.')[1]));
                const myId = payload.id;

                msgs.forEach(m => {
                    const type = m.sender_id === myId ? 'sent' : 'received';
                    div.innerHTML += `<div class="message ${type}">${m.message}</div>`;
                });
                div.scrollTop = div.scrollHeight;
            } catch (err) {
                console.error(err);
            }
        }

        async function sendMessage() {
            const chatId = document.getElementById('chat-select').value;
            const text = document.getElementById('msg-input').value;
            if (!chatId || !text) return;

            try {
                await apiCall(`/chat/${chatId}/messages`, 'POST', { message: text });
                document.getElementById('msg-input').value = '';
                loadMessages();
            } catch (err) {
                alert('Erro ao enviar');
            }
        }
    </script>
</body>

</html>